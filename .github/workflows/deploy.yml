name: Deploy SeriusStore

on:
  push:
    branches:
      - dev
      - prod
      - master

jobs:
  test:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test Backend (Build)
        run: |
          echo "üß™ Testing Backend Build..."
          cd backend
          # Use docker to build to ensure environment consistency without installing go on host
          docker build -t test-backend-${{ github.sha }} .
          docker image rm test-backend-${{ github.sha }}

      - name: Test Frontend (Build)
        run: |
          echo "üß™ Testing Frontend Build..."
          cd frontend
          # Use docker to build
          docker build -t test-frontend-${{ github.sha }} .
          docker image rm test-frontend-${{ github.sha }}

  deploy:
    needs: test
    runs-on: self-hosted
    if: success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment
        id: set-env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/dev" ]]; then
            echo "ENV=dev" >> $GITHUB_OUTPUT
            echo "COMPOSE_FILE=docker-compose.dev.yml" >> $GITHUB_OUTPUT
          else
            echo "ENV=prod" >> $GITHUB_OUTPUT
            echo "COMPOSE_FILE=docker-compose.prod.yml" >> $GITHUB_OUTPUT
          fi

      - name: Deploy ${{ steps.set-env.outputs.ENV }}
        run: |
          echo "üöÄ Deploying to ${{ steps.set-env.outputs.ENV }} environment..."
          docker-compose -f ${{ steps.set-env.outputs.COMPOSE_FILE }} down || true
          docker-compose -f ${{ steps.set-env.outputs.COMPOSE_FILE }} up -d --build
          echo "‚úÖ Deployment complete!"

      - name: Health check
        run: |
          sleep 10
          if [[ "${{ steps.set-env.outputs.ENV }}" == "dev" ]]; then
            curl -f http://localhost:3001 || echo "‚ö†Ô∏è Frontend dev not responding"
            curl -f http://localhost:8081/api/health || echo "‚ö†Ô∏è Backend dev not responding"
          else
            curl -f http://localhost:3000 || echo "‚ö†Ô∏è Frontend prod not responding"
            curl -f http://localhost:8080/api/health || echo "‚ö†Ô∏è Backend prod not responding"
          fi

      - name: Cleanup old images
        run: |
          docker image prune -f
